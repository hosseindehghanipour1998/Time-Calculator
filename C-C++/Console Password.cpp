#include <iostream>
#include <stdexcept>
#include <string>
#include <windows.h>
using namespace std;

string getpassword(const string& prompt = "Enter password> ")
{
  string result;

  // Set the console mode to no-echo, not-line-buffered input
  DWORD mode, count;
  HANDLE ih = GetStdHandle(STD_INPUT_HANDLE);
  HANDLE oh = GetStdHandle(STD_OUTPUT_HANDLE);
  if (!GetConsoleMode(ih, &mode))
    throw runtime_error(
      "getpassword: You must be connected to a console to use this program.\n"
    );
  SetConsoleMode(ih, mode & ~(ENABLE_ECHO_INPUT | ENABLE_LINE_INPUT));

  // Get the password string
  WriteConsoleA(oh, prompt.c_str(), prompt.length(), &count, NULL);
  char c;
  while (ReadConsoleA(ih, &c, 1, &count, NULL) && (c != '\r') && (c != '\n'))
  {
    if (c == '\b')
    {
      if (result.length())
      {
        WriteConsoleA(oh, "\b \b", 3, &count, NULL);
        result.erase(result.end() - 1);
      }
    }
    else
    {
      WriteConsoleA(oh, "*", 1, &count, NULL);
      result.push_back(c);
    }
  }

  // Restore the console mode
  SetConsoleMode(ih, mode);

  return result;
}

int main()
{
  try {

    string password = getpassword("Enter a test password: ");
    cout << "\nYour password is: " << endl << password << endl;

  }
  catch (exception& e)
  {
    cerr << e.what();
    return 1;
  }

  return 0;
}
